<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LVM Extent Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="extents.js"></script>
  <script src="planner.js"></script>
  <script src="utils.js"></script>
  <script src="pvs.js"></script>
  <script src="ui.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .help { background: #eef; padding: 10px; margin-bottom: 15px; border-left: 4px solid #88f; }
    textarea { width: 100%; height: 200px; margin-bottom: 10px; font-family: monospace; }
    button { margin-bottom: 10px; padding: 6px 12px; cursor: pointer; }
    .pv-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
    .pv { border: 1px solid #ccc; padding: 10px; min-width: 240px; background: #f9f9f9; }
    .pv h3 { margin-top: 0; font-size: 16px; word-break: break-word; }
    .extent { padding: 4px; margin: 2px 0; background: #e0e0ff; cursor: grab; font-size: 12px; border-left: 6px solid; position: relative; }
    .extent.free { background: #d0ffd0; border-left-color: #8c8; }
    .extent:hover { opacity: 0.9; }
    .extent.moved::after {
      content: 'moved';
      position: absolute;
      right: 4px;
      top: 2px;
      font-size: 10px;
      color: #333;
      background: #fff6b2;
      padding: 0 4px;
      border-radius: 3px;
    }
    pre { background: #eee; padding: 10px; white-space: pre-wrap; }
    .error { color: red; font-weight: bold; }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      transform: translate(-50%, -50%);
      background: white;
      padding: 16px;
      border: 1px solid #aaa;
      box-shadow: 0 0 10px rgba(0,0,0,0.25);
      z-index: 1000;
    }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    #splitSlider {
      width: 100%;
    }
  </style>
</head>
<body>

<h1>LVM Extent Manager</h1>

<div class="help" style="background: #ffe0e0; border-left-color: #f55;">
  ⚠️ <strong>Disclaimer:</strong> This tool is experimental, untested, and may produce incorrect or unsafe results. Use at your own risk.
</div>

<div class="help">
  <strong>Step 1:</strong> Run this command and paste the output below:<br>
  <code>pvs -o segtype,lv_name,seg_start_pe,seg_size_pe,pvseg_all,pv_name --reportformat json</code>
  <button onclick="copyPvsCommand()">Copy</button>
</div>

<textarea id="jsonInput" placeholder="Paste JSON here..."></textarea>
<button onclick="parseJSON()">Parse</button>
<button onclick="parseUserJSON()" id="restoreButton" disabled>Restore</button>
<div id="errorMessage" class="error"></div>

<div class="help">
  <strong>Step 2:</strong> Re-order extents:<br>
</div>

<div class="pv-container" id="pvContainer"></div>

<div class="help">
  <strong>Step 3:</strong> Copy commands:<br>
  <button onclick="generateCommands()">Generate</button>
  <button onclick="copyGeneratedCommands()">Copy</button>
</div>
<pre id="commandsOutput"># No changes yet</pre>

<div class="help">
  <strong>Step 4:</strong> Inspect logs:<br>
</div>
<pre id="debugJson"></pre>

<!-- Modal for splitting -->
<div id="modalOverlay" class="modal-overlay" style="display:none;"></div>
<div id="splitModal" class="modal" style="display:none;">
  <h4>Split Extent</h4>
  <p id="splitLabel">Size: </p>
  <input type="range" id="splitSlider" min="1" max="1" value="1" />
  <button onclick="confirmSplit()">Split</button>
  <button onclick="closeSplitModal()">Cancel</button>
</div>

<footer style="font-size: 0.9em; color: #666; text-align: center;">
  <div>
    <hr/>
    Kamil Trzciński (c) 2025 | 
    <a href="https://github.com/ayufan/lvm2defrag-web" target="_blank" rel="noopener noreferrer">GitHub</a> |
    <a href="https://ko-fi.com/ayufan" target="_blank" rel="noopener noreferrer">Buy a Coffee</a>
  </div>
</footer>

<script>
function parseJSON() {
  try {
    const jsonInput = document.getElementById('jsonInput').value.trim();
    const segments = parsePVSReport(jsonInput);
    setPVs(segments);
    loadedReport = dumpPVs();

    if (localStorage.getItem('lvm_json') !== jsonInput) {
      localStorage.removeItem('lvm_user_json');
    }

    localStorage.setItem('lvm_json', jsonInput);
    document.getElementById('restoreButton').disabled = localStorage.getItem('lvm_user_json') ? false : true;
  } catch (e) {
    document.getElementById('errorMessage').innerText = `Invalid JSON: ${e.message}`;
  }
}

function parseUserJSON() {
  try {
    const jsonInput = localStorage.getItem('lvm_user_json');
    if (!jsonInput) {
      return;
    }

    const segments = JSON.parse(jsonInput);
    setPVs(segments);
  } catch (e) {
    document.getElementById('errorMessage').innerText = `Invalid JSON: ${e.message}`;
  }
}

function saveUserJSON() {
  const currentOrder = dumpPVs();
  localStorage.setItem('lvm_user_json', JSON.stringify(currentOrder));
}

function generateCommands() {
  const queue = [];
  const freeSets = new ExtentSetsWithNames();

  // load settings
  pvOrder.forEach(pv => {
    const list = document.getElementById(`pv-${safeId(pv)}`);
    freeSets.set(pv).indirectAllowed = document.querySelector(`.use-indirect[data-pv="${pv}"]`)?.checked;
    freeSets.set(pv).localAllowed = document.querySelector(`.use-local[data-pv="${pv}"]`)?.checked;
    freeSets.set(pv).splitAllowed = document.querySelector(`.use-split[data-pv="${pv}"]`)?.checked;
  });

  // load free space
  for (const loaded of loadedReport) {
    if (loaded.lv_name) continue; // Skip LV extents
    freeSets.add(loaded.pv_name, loaded.pv_start, loaded.pv_size);
  }

  // load segments to move
  for (const segment of dumpPVs()) {
    if (!segment.moved) continue;

    queue.push({
      from_start: segment.pv_start,
      from_set: segment.pv_name,
      to_start: segment.moved_pv_start,
      to_set: segment.moved_pv_name,
      size: segment.pv_size,
      name: `${segment.lv_name} #${segment.index}[${segment.lv_start}-${segment.lv_start + segment.lv_size - 1}]`
    })
  }

  let { moves, failedMoves } = planMoves(queue, freeSets);

  if (failedMoves.length > 0) {
    document.getElementById('errorMessage').innerText = `❌ Failed to find enough free space for ${failedMoves.length} extents`;
  } else {
    document.getElementById('errorMessage').innerText = '';
  }

  const commands = [];
  let extentsMoved = { total: 0, indirect: 0, full: 0, partial: 0, cost: 1, indirect_cost: 0 };

  for (let i = 0; i < moves.length; i++) {
    const move = moves[i];
    const cost = move.size * (move.from_set == move.to_set ? 3 : 1);
    extentsMoved.total += move.size;
    extentsMoved.cost += cost;
    if (move.type === 'indirect') {
      extentsMoved.indirect += move.size;
      extentsMoved.indirect_cost += cost;
    } else if (move.type === 'full') {
      extentsMoved.full += move.size;
    } else if (move.type === 'partial') {
      extentsMoved.partial += move.size;
    }
  }

  let extentsCount = 0;

  for (let i = 0; i < moves.length; i++) {
    const move = moves[i];
    commands.push(
      `# Move ${move.name} ${move.type} from ${move.from_set}[${move.from_start}-${move.from_start + move.size - 1}] to ${move.to_set}[${move.to_start}-${move.to_start + move.size - 1}] (${move.size} extents)`,
      `echo "Move ${i+1} out of ${moves.length}. At ${(extentsCount*100/extentsMoved.total).toFixed(2)}%. Moving ${move.size} extents."`,
      `pvmove --alloc anywhere ${move.from_set}:${move.from_start}-${move.from_start + move.size - 1} ${move.to_set}:${move.to_start}-${move.to_start + move.size - 1}`,
      ``
    );

    extentsCount += move.size;
  }

  for (let i = 0; i < failedMoves.length; i++) {
    const move = failedMoves[i];
    commands.push(
      `# Failed to move ${move.name} from ${move.from_set}[${move.from_start}-${move.from_start + move.size - 1}] to ${move.to_set}[${move.to_start}-${move.to_start + move.size - 1}]`,
      `# Not enough free space available`,
      ``
    );
  }

  commands.unshift(
    `# Total extents moved: ${extentsMoved.total}`,
    `# Full extents moved: ${extentsMoved.full}`,
    `# Partial extents moved: ${extentsMoved.partial}`,
    `# Indirect extents moved: ${extentsMoved.indirect}`,
    `# Total moves planned: ${moves.length}`,
    `# Failed moves: ${failedMoves.length}`,
    `# Estimated cost (lower is better): ${((extentsMoved.cost - extentsMoved.indirect_cost) / extentsMoved.cost).toFixed(2)}`,
    ``
  );

  document.getElementById('commandsOutput').innerText = commands.length ? commands.join('\n') : "# No changes.";
  document.getElementById('debugJson').innerText = 
    `const queue = ${JSON.stringify(queue, null, 2)};\n\n` +
    `const free = ${JSON.stringify(freeSets, null, 2)};`;
}

function copyGeneratedCommands() {
  navigator.clipboard.writeText(document.getElementById('commandsOutput').innerText);
}

// Extent splitting logic
let selectedExtent = null;

document.addEventListener("click", function (e) {
  if (e.target.classList.contains("extent") && !e.target.classList.contains("free")) {
    selectedExtent = e.target;
    const max = parseInt(selectedExtent.dataset.pv_size);
    if (max <= 1) return;
    document.getElementById("splitSlider").max = max - 1;
    document.getElementById("splitSlider").value = 1;
    document.getElementById("splitLabel").innerText = `Split ${selectedExtent.innerText} into:`;
    document.getElementById("splitModal").style.display = "block";
    document.getElementById("modalOverlay").style.display = "block";
  }
});

function closeSplitModal() {
  document.getElementById("splitModal").style.display = "none";
  document.getElementById("modalOverlay").style.display = "none";
  selectedExtent = null;
}

function confirmSplit() {
  const splitSize = parseInt(document.getElementById("splitSlider").value);
  if (!selectedExtent) return;

  const totalSize = parseInt(selectedExtent.dataset.pv_size);
  const secondSize = totalSize - splitSize;

  const clone = selectedExtent.cloneNode(true);
  selectedExtent.dataset.pv_size = splitSize;
  selectedExtent.dataset.index += "-1";
  selectedExtent.innerText = `${selectedExtent.dataset.lv_name} #${selectedExtent.dataset.index}:${splitSize}`;

  clone.dataset.index += "-2";
  clone.dataset.pv_size = secondSize;
  clone.dataset.moved_pv_start = parseInt(selectedExtent.dataset.moved_pv_start) + splitSize;
  clone.dataset.pv_start = parseInt(selectedExtent.dataset.pv_start) + splitSize;
  clone.innerText = `${clone.dataset.lv_name} #${clone.dataset.index}:${secondSize}`;

  selectedExtent.parentElement.insertBefore(clone, selectedExtent.nextSibling);

  closeSplitModal();
  updatePVs();
  saveUserJSON();
}

window.onload = () => {
  const saved = localStorage.getItem('lvm_json');
  if (saved) {
    document.getElementById('jsonInput').value = saved;
    parseJSON();
    parseUserJSON();
  }
};
</script>

</body>
</html>
